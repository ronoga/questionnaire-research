<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پرسشنامه پژوهشی - دانشگاه پیام نور اردکان</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <!-- Persian Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
        }
        
        * {
            font-family: Vazir, sans-serif;
        }
        
        body {
            background-color: #f8f9fc;
            line-height: 1.8;
            padding-top: 20px;
        }
        
        .form-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s;
        }
        
        .form-container:hover {
            box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
        }
        
        .form-title {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-title:after {
            content: '';
            position: absolute;
            bottom: -3px;
            right: 0;
            width: 100px;
            height: 3px;
            background: var(--success-color);
        }
        
        .question-item {
            padding: 15px;
            margin-bottom: 15px;
            border-right: 4px solid #e3e6f0;
            border-radius: 8px;
            transition: all 0.3s;
            background-color: #f8f9fc;
        }
        
        .question-item:hover {
            border-right-color: var(--primary-color);
            background-color: #f0f3ff;
        }
        
        .question-text {
            font-weight: 500;
            color: #5a5c69;
            margin-bottom: 10px;
        }
        
        .scale-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .scale-option {
            flex: 1;
            min-width: 120px;
        }
        
        .scale-option input[type="radio"] {
            display: none;
        }
        
        .scale-option label {
            display: block;
            padding: 10px 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e3e6f0;
            background: white;
            font-size: 0.9rem;
        }
        
        .scale-option input[type="radio"]:checked + label {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 115, 223, 0.2);
        }
        
        /* حذف نمایش اعداد از روی labelها */
        .scale-option label br,
        .scale-option label small {
            display: none;
        }
        
        .section-title {
            background: linear-gradient(90deg, #f8f9fc, #e3e6f0);
            padding: 12px 20px;
            border-radius: 10px;
            margin: 25px 0 15px;
            font-weight: 600;
            color: var(--primary-color);
            border-right: 4px solid var(--primary-color);
        }
        
        .progress-container {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            height: 5px;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.5s;
        }
        
        .form-nav {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            border-radius: 15px 15px 0 0;
            z-index: 999;
        }
        
        .required-star {
            color: var(--danger-color);
        }
        
        .submit-btn {
            background: linear-gradient(90deg, var(--primary-color), #6a8bf0);
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(78, 115, 223, 0.3);
        }
        
        .alert-custom {
            border-right: 5px solid var(--info-color);
            border-radius: 10px;
        }
        
        .demographic-section {
            background: linear-gradient(135deg, #f8f9fc 0%, #e3e6f0 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e3e6f0;
        }
        
        .form-select-lg {
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .form-container {
                padding: 1rem;
            }
            
            .scale-option {
                min-width: 80px;
            }
            
            .scale-option label {
                padding: 8px 5px;
                font-size: 0.8rem;
            }
            
            body {
                padding-top: 10px;
            }
        }
        
        /* استایل برای نمایش مقیاس */
        .scale-label-container {
            background: #f8f9fc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #e3e6f0;
        }
        
        .scale-label-item {
            text-align: center;
            padding: 5px;
        }
        
        .scale-label-item span {
            font-weight: bold;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Main Container -->
    <div class="container py-4">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="fw-bold text-primary mb-3">پرسشنامه پژوهشی</h1>
            <h4 class="text-secondary mb-4">نقش سبک‌های هیجانی و خودشفقتی در پیش‌بینی سلامت روان دانشجویان دختر</h4>
            <div class="alert alert-custom alert-info">
                <i class="bi bi-info-circle-fill me-2"></i>
                <strong>توضیح مهم:</strong> این پرسشنامه صرفاً برای اهداف پژوهشی تهیه شده است. اطلاعات شما کاملاً محرمانه بوده و فقط به‌صورت کلی تحلیل می‌شود. شرکت در این پژوهش داوطلبانه است و در هر زمان می‌توانید از ادامه پاسخ‌دهی انصراف دهید.
            </div>
        </div>

        <!-- Research Info - با اطلاعات دموگرافیک جدید -->
        <div class="form-container mb-4" id="form0">
            <h3 class="form-title">اطلاعات دموگرافیک</h3>
            
            <div class="demographic-section">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="age" class="form-label">سن شما <span class="required-star">*</span></label>
                        <input type="number" class="form-control form-control-lg" id="age" name="age" min="15" max="50" required>
                        <div class="form-text">لطفاً سن خود را به عدد وارد کنید (15 تا 50 سال)</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="studentCode" class="form-label">کد دانشجویی (اختیاری)</label>
                        <input type="text" class="form-control form-control-lg" id="studentCode" name="studentCode">
                        <div class="form-text">در صورت تمایل کد دانشجویی خود را وارد کنید</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="educationLevel" class="form-label">مقطع تحصیلی <span class="required-star">*</span></label>
                        <select class="form-select form-select-lg" id="educationLevel" name="educationLevel" required>
                            <option value="" selected disabled>لطفاً انتخاب کنید</option>
                            <option value="1">کاردانی</option>
                            <option value="2">کارشناسی</option>
                            <option value="3">کارشناسی ارشد</option>
                            <option value="4">دکتری</option>
                        </select>
                        <div class="form-text">برای کنترل اثر سطح تحصیل</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="semester" class="form-label">ترم/سال تحصیلی <span class="required-star">*</span></label>
                        <select class="form-select form-select-lg" id="semester" name="semester" required>
                            <option value="" selected disabled>لطفاً انتخاب کنید</option>
                            <option value="1">ترم ۱-۲</option>
                            <option value="2">ترم ۳-۵</option>
                            <option value="3">ترم ۶ به بالا</option>
                        </select>
                        <div class="form-text">برای کنترل تجربه و فشار تحصیلی</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fieldOfStudy" class="form-label">رشته تحصیلی <span class="required-star">*</span></label>
                        <select class="form-select form-select-lg" id="fieldOfStudy" name="fieldOfStudy" required>
                            <option value="" selected disabled>لطفاً انتخاب کنید</option>
                            <option value="1">علوم انسانی</option>
                            <option value="2">علوم پایه</option>
                            <option value="3">فنی و مهندسی</option>
                            <option value="4">علوم پزشکی و سلامت</option>
                            <option value="5">هنر</option>
                            <option value="6">کشاورزی و منابع طبیعی</option>
                            <option value="7">سایر</option>
                        </select>
                        <div class="form-text">برای کنترل تفاوت‌های محیطی و آکادمیک</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="residenceStatus" class="form-label">وضعیت سکونت <span class="required-star">*</span></label>
                        <select class="form-select form-select-lg" id="residenceStatus" name="residenceStatus" required>
                            <option value="" selected disabled>لطفاً انتخاب کنید</option>
                            <option value="1">با خانواده</option>
                            <option value="2">خوابگاه دانشجویی</option>
                            <option value="3">خانه مستقل</option>
                            <option value="4">سایر</option>
                        </select>
                        <div class="form-text">برای کنترل حمایت اجتماعی و استرس مرتبط</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary btn-lg px-5" onclick="showNextForm()">
                    شروع پرسشنامه‌ها <i class="bi bi-arrow-left ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Form 1: GHQ-28 -->
        <div class="form-container" id="form1" style="display: none;">
            <h3 class="form-title">پرسشنامه سلامت عمومی (GHQ-28)</h3>
            <p class="text-muted mb-4">
                <i class="bi bi-journal-text me-2"></i>
                <strong>راهنما:</strong> لطفاً هر سؤال را با توجه به وضعیت خود در <strong>چند هفته اخیر</strong> پاسخ دهید.
            </p>
            
            <!-- Scale Legend بدون اعداد روی label -->
            <div class="alert alert-light border mb-4">
                <div class="row text-center scale-label-container">
                    <div class="col-3 scale-label-item">
                        <span>اصلاً</span>
                    </div>
                    <div class="col-3 scale-label-item">
                        <span>کم</span>
                    </div>
                    <div class="col-3 scale-label-item">
                        <span>زیاد</span>
                    </div>
                    <div class="col-3 scale-label-item">
                        <span>خیلی زیاد</span>
                    </div>
                </div>
            </div>
            
            <div id="ghq-questions">
                <!-- Questions will be populated by JavaScript -->
            </div>
        </div>

        <!-- Form 2: SCS -->
        <div class="form-container" id="form2" style="display: none;">
            <h3 class="form-title">پرسشنامه خودشفقتی (SCS – 26 گویه)</h3>
            
            <!-- Scale Legend بدون اعداد روی label -->
            <div class="alert alert-light border mb-4">
                <div class="row text-center scale-label-container">
                    <div class="col scale-label-item">
                        <span>کاملاً مخالفم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>مخالفم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>نظری ندارم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>موافقم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>کاملاً موافقم</span>
                    </div>
                </div>
            </div>
            
            <div id="scs-questions">
                <!-- Questions will be populated by JavaScript -->
            </div>
        </div>

        <!-- Form 3: ESQ -->
        <div class="form-container" id="form3" style="display: none;">
            <h3 class="form-title">پرسشنامه سبک‌های هیجانی (ESQ – 24 گویه)</h3>
            
            <!-- Scale Legend بدون اعداد روی label -->
            <div class="alert alert-light border mb-4">
                <div class="row text-center scale-label-container">
                    <div class="col scale-label-item">
                        <span>کاملاً مخالفم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>مخالفم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>نظری ندارم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>موافقم</span>
                    </div>
                    <div class="col scale-label-item">
                        <span>کاملاً موافقم</span>
                    </div>
                </div>
            </div>
            
            <div id="esq-questions">
                <!-- Questions will be populated by JavaScript -->
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="form-nav mt-4" id="formNav" style="display: none;">
            <div class="row">
                <div class="col-md-6 mb-3 mb-md-0">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="showPreviousForm()">
                        <i class="bi bi-arrow-right me-2"></i> فرم قبلی
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary w-100 submit-btn" onclick="showNextForm()">
                        فرم بعدی <i class="bi bi-arrow-left ms-2"></i>
                    </button>
                </div>
            </div>
            <div class="text-center mt-3">
                <div id="formIndicator" class="badge bg-info p-2">فرم ۰ از ۴</div>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="form-container text-center mt-4" id="submitSection" style="display: none;">
            <h3 class="form-title text-success">تکمیل پرسشنامه</h3>
            <div class="alert alert-success">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>تبریک!</strong> شما به انتهای پرسشنامه رسیده‌اید. لطفاً قبل از ارسال نهایی، پاسخ‌های خود را مرور کنید.
            </div>
            <button type="button" class="btn btn-success btn-lg px-5" onclick="submitAllForms()">
                <i class="bi bi-send-check me-2"></i> ارسال نهایی پاسخ‌ها
            </button>
            <div class="mt-3">
                <button type="button" class="btn btn-outline-primary" onclick="reviewAnswers()">
                    <i class="bi bi-eye me-2"></i> مرور پاسخ‌ها
                </button>
            </div>
        </div>

        <!-- Loading Modal -->
        <div class="modal fade" id="loadingModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center py-5">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                        <h5 class="text-primary">در حال ذخیره اطلاعات...</h5>
                        <p class="text-muted mt-2">لطفاً چند لحظه صبر کنید</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="modal fade" id="successModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center py-5">
                        <div class="mb-3">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-success">پاسخ‌های شما با موفقیت ثبت شد!</h4>
                        <p class="text-muted mt-3">با تشکر از مشارکت شما در این پژوهش</p>
                        <button type="button" class="btn btn-success mt-3" data-bs-dismiss="modal">بستن</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        (function() {
            'use strict';
            
            // Supabase Configuration
            const SUPABASE_URL = 'https://przbbhjdxytirhepfiwt.supabase.co';
            const SUPABASE_ANON_KEY = 'sb_publishable_sv61-GOMaW1nBXV_aKGpww_laLO4Fzv';
            
            let supabaseClient = null;
            
            const forms = [
                { id: 'form0', title: 'اطلاعات دموگرافیک' },
                { id: 'form1', title: 'GHQ-28' },
                { id: 'form2', title: 'SCS' },
                { id: 'form3', title: 'ESQ' }
            ];
            
            let currentFormIndex = 0;
            
            // سوالات GHQ-28
            const ghqQuestions = [
                { section: 'علائم جسمانی', questions: [
                    'احساس خستگی یا بی‌حالی داشته‌اید؟',
                    'احساس کرده‌اید نیاز به استراحت دارید؟',
                    'دچار سردرد شده‌اید؟',
                    'احساس فشار یا درد در سر داشته‌اید؟',
                    'دچار ضعف عمومی بدن بوده‌اید؟',
                    'احساس ناخوشی جسمی داشته‌اید؟',
                    'دچار تپش قلب یا لرزش شده‌اید؟'
                ]},
                { section: 'اضطراب و بی‌خوابی', questions: [
                    'دچار نگرانی یا اضطراب شده‌اید؟',
                    'احساس تنش یا عصبی بودن داشته‌اید؟',
                    'خواب شما دچار اختلال شده است؟',
                    'به سختی به خواب رفته‌اید؟',
                    'احساس بی‌قراری داشته‌اید؟',
                    'به‌راحتی آرام نمی‌شده‌اید؟',
                    'احساس ترس بدون دلیل داشته‌اید؟'
                ]},
                { section: 'کارکرد اجتماعی', questions: [
                    'احساس کرده‌اید قادر به انجام وظایف روزمره نیستید؟',
                    'احساس ناتوانی در تصمیم‌گیری داشته‌اید؟',
                    'تمرکز شما کاهش یافته است؟',
                    'احساس کرده‌اید کارها برایتان دشوار شده‌اند؟',
                    'از فعالیت‌های روزمره لذت کمتری برده‌اید؟',
                    'احساس نارضایتی از عملکرد خود داشته‌اید؟',
                    'احساس کرده‌اید مفید نیستید؟'
                ]},
                { section: 'افسردگی شدید', questions: [
                    'احساس ناامیدی کرده‌اید؟',
                    'احساس بی‌ارزشی داشته‌اید؟',
                    'احساس کرده‌اید زندگی ارزش ادامه دادن ندارد؟',
                    'افکار منفی شدید داشته‌اید؟',
                    'احساس افسردگی عمیق کرده‌اید؟',
                    'تمایل به کناره‌گیری از دیگران داشته‌اید؟',
                    'احساس کرده‌اید زندگی بی‌معناست؟'
                ]}
            ];

            // سوالات SCS (سوالات معکوس فقط در کد: 2,4,6,8,10,12,14,16,18,20,22,24,26)
            const scsQuestions = [
                'وقتی اشتباه می‌کنم، با خودم مهربان هستم.',
                'وقتی شکست می‌خورم، خودم را به‌شدت سرزنش می‌کنم.',
                'احساس می‌کنم رنج کشیدن بخشی از تجربه انسانی است.',
                'وقتی ناراحت هستم، احساس می‌کنم فقط من چنین احساسی دارم.',
                'سعی می‌کنم احساسات دردناک خود را با تعادل بپذیرم.',
                'وقتی ناکام می‌شوم، خودم را بی‌ارزش می‌دانم.',
                'به خودم یادآوری می‌کنم که دیگران هم چنین مشکلاتی دارند.',
                'وقتی شرایط سخت است، بیش از حد در احساساتم غرق می‌شوم.',
                'با خودم همان‌طور رفتار می‌کنم که با یک دوست صمیمی رفتار می‌کنم.',
                'وقتی شکست می‌خورم، احساس تنهایی می‌کنم.',
                'احساسات منفی‌ام را بدون اغراق مشاهده می‌کنم.',
                'نسبت به نقص‌های خودم سخت‌گیر هستم.',
                'احساس می‌کنم انسان‌ها به‌طور طبیعی دچار خطا می‌شوند.',
                'مشکلاتم را بزرگ‌تر از حد واقعی‌شان می‌بینم.',
                'در مواقع سختی، به خودم محبت می‌کنم.',
                'احساس می‌کنم دیگران زندگی بهتری از من دارند.',
                'سعی می‌کنم با ذهن‌آگاهی با احساساتم روبه‌رو شوم.',
                'وقتی اشتباه می‌کنم، خودم را سرزنش می‌کنم.',
                'می‌دانم که رنج کشیدن بخشی از زندگی است.',
                'وقتی ناراحت هستم، احساس می‌کنم از دیگران جدا شده‌ام.',
                'احساساتم را بدون قضاوت مشاهده می‌کنم.',
                'نسبت به خودم بیش از حد انتقادی هستم.',
                'با خودم صبور هستم.',
                'احساس می‌کنم مشکلاتم فقط مخصوص من است.',
                'اجازه می‌دهم احساساتم بیایند و بروند.',
                'وقتی شکست می‌خورم، خودم را تحقیر می‌کنم.'
            ];

            // سوالات ESQ (سوالات معکوس فقط در کد: 2,8,13,20)
            const esqQuestions = [
                'بعد از یک اتفاق ناراحت‌کننده سریع به حالت عادی برمی‌گردم.',
                'احساسات منفی مدت زیادی در من باقی می‌مانند.',
                'معمولاً دیدگاه مثبتی نسبت به آینده دارم.',
                'می‌توانم احساسات درونی‌ام را به‌خوبی تشخیص دهم.',
                'به‌راحتی هیجان‌های دیگران را درک می‌کنم.',
                'می‌دانم در هر موقعیت چگونه احساساتم را بروز دهم.',
                'هنگام فشار روانی تمرکزم را حفظ می‌کنم.',
                'به‌سختی از هیجان‌های منفی رها می‌شوم.',
                'احساسات مثبت را در خودم حفظ می‌کنم.',
                'به تغییرات هیجانی بدنم آگاه هستم.',
                'حالات چهره دیگران را سریع متوجه می‌شوم.',
                'در موقعیت‌های مختلف واکنش هیجانی مناسبی دارم.',
                'به‌راحتی حواسم پرت می‌شود.',
                'بعد از ناکامی، سریع بازیابی می‌شوم.',
                'معمولاً خوش‌بین هستم.',
                'هیجان‌هایم را دقیق نام‌گذاری می‌کنم.',
                'در تعاملات اجتماعی هیجان‌ها را خوب می‌فهمم.',
                'واکنش هیجانی‌ام با موقعیت هماهنگ است.',
                'تمرکز ذهنی خوبی دارم.',
                'مدت زیادی در احساسات منفی می‌مانم.',
                'می‌توانم احساسات مثبت را تقویت کنم.',
                'به نشانه‌های درونی بدنم توجه دارم.',
                'حالات هیجانی دیگران را به‌خوبی درک می‌کنم.',
                'هنگام هیجان، کنترل توجه خود را از دست نمی‌دهم'
            ];

            // تابع مقداردهی اولیه Supabase
            function initSupabase() {
                try {
                    if (typeof supabase === 'undefined') {
                        console.warn('Supabase library not loaded');
                        return false;
                    }
                    
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase client initialized successfully');
                    return true;
                } catch (error) {
                    console.error('Error initializing Supabase:', error);
                    return false;
                }
            }

            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                initSupabase();
                renderGHQQuestions();
                renderSCSQuestions();
                renderESQQuestions();
                updateFormIndicator();
                updateProgressBar();
                showCurrentForm();
            });

            function getGHQLabel(value) {
                const labels = {1: 'اصلاً', 2: 'کم', 3: 'زیاد', 4: 'خیلی زیاد'};
                return labels[value];
            }

            function getSCSLabel(value) {
                const labels = {1: 'کاملاً مخالفم', 2: 'مخالفم', 3: 'نظری ندارم', 4: 'موافقم', 5: 'کاملاً موافقم'};
                return labels[value];
            }

            function getESQLabel(value) {
                return getSCSLabel(value);
            }

            // رندر سوالات GHQ
            function renderGHQQuestions() {
                const container = document.getElementById('ghq-questions');
                let questionNumber = 1;
                
                ghqQuestions.forEach((section) => {
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = `${section.section}`;
                    container.appendChild(sectionTitle);
                    
                    section.questions.forEach((question) => {
                        const questionItem = document.createElement('div');
                        questionItem.className = 'question-item';
                        questionItem.innerHTML = `
                            <div class="question-text">
                                ${questionNumber}. ${question}
                            </div>
                            <div class="scale-options">
                                ${[1, 2, 3, 4].map(value => `
                                    <div class="scale-option">
                                        <input type="radio" id="ghq_${questionNumber}_${value}" 
                                               name="ghq_${questionNumber}" value="${value}" 
                                               onchange="updateProgressBar()">
                                        <label for="ghq_${questionNumber}_${value}">
                                            ${getGHQLabel(value)}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        container.appendChild(questionItem);
                        questionNumber++;
                    });
                });
            }

            // رندر سوالات SCS
            function renderSCSQuestions() {
                const container = document.getElementById('scs-questions');
                
                scsQuestions.forEach((question, index) => {
                    const questionNumber = index + 1;
                    
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item';
                    questionItem.innerHTML = `
                        <div class="question-text">
                            ${questionNumber}. ${question}
                        </div>
                        <div class="scale-options">
                            ${[1, 2, 3, 4, 5].map(value => `
                                <div class="scale-option">
                                    <input type="radio" id="scs_${questionNumber}_${value}" 
                                           name="scs_${questionNumber}" value="${value}"
                                           onchange="updateProgressBar()">
                                    <label for="scs_${questionNumber}_${value}">
                                        ${getSCSLabel(value)}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(questionItem);
                });
            }

            // رندر سوالات ESQ
            function renderESQQuestions() {
                const container = document.getElementById('esq-questions');
                
                esqQuestions.forEach((question, index) => {
                    const questionNumber = index + 1;
                    
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item';
                    questionItem.innerHTML = `
                        <div class="question-text">
                            ${questionNumber}. ${question}
                        </div>
                        <div class="scale-options">
                            ${[1, 2, 3, 4, 5].map(value => `
                                <div class="scale-option">
                                    <input type="radio" id="esq_${questionNumber}_${value}" 
                                           name="esq_${questionNumber}" value="${value}"
                                           onchange="updateProgressBar()">
                                    <label for="esq_${questionNumber}_${value}">
                                        ${getESQLabel(value)}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(questionItem);
                });
            }

            // Navigation functions
            function showCurrentForm() {
                forms.forEach((form, index) => {
                    const formElement = document.getElementById(form.id);
                    formElement.style.display = index === currentFormIndex ? 'block' : 'none';
                });
                
                updateFormIndicator();
                updateProgressBar();
                
                if (currentFormIndex === 0) {
                    document.getElementById('formNav').style.display = 'none';
                    document.getElementById('submitSection').style.display = 'none';
                } else if (currentFormIndex === forms.length - 1) {
                    document.getElementById('formNav').style.display = 'block';
                    document.getElementById('submitSection').style.display = 'none';
                } else if (currentFormIndex === forms.length) {
                    document.getElementById('formNav').style.display = 'none';
                    document.getElementById('submitSection').style.display = 'block';
                } else {
                    document.getElementById('formNav').style.display = 'block';
                    document.getElementById('submitSection').style.display = 'none';
                }
                
                scrollToTopOfCurrentForm();
            }

            function scrollToTopOfCurrentForm() {
                const currentFormId = forms[currentFormIndex]?.id;
                if (currentFormId) {
                    const formElement = document.getElementById(currentFormId);
                    if (formElement) {
                        formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }

            function showNextForm() {
                if (!validateCurrentForm()) {
                    return;
                }
                
                if (currentFormIndex < forms.length - 1) {
                    currentFormIndex++;
                    showCurrentForm();
                } else if (currentFormIndex === forms.length - 1) {
                    currentFormIndex = forms.length;
                    showCurrentForm();
                }
            }

            function showPreviousForm() {
                if (currentFormIndex > 0) {
                    if (currentFormIndex === forms.length) {
                        currentFormIndex = forms.length - 1;
                    } else {
                        currentFormIndex--;
                    }
                    showCurrentForm();
                }
            }

            function validateCurrentForm() {
                if (currentFormIndex === 0) {
                    const age = document.getElementById('age').value;
                    if (!age || age < 15 || age > 50) {
                        alert('لطفاً سن خود را به درستی وارد کنید (بین 15 تا 50 سال).');
                        return false;
                    }
                    
                    if (!document.getElementById('educationLevel').value) {
                        alert('لطفاً مقطع تحصیلی خود را انتخاب کنید.');
                        return false;
                    }
                    
                    if (!document.getElementById('semester').value) {
                        alert('لطفاً ترم/سال تحصیلی خود را انتخاب کنید.');
                        return false;
                    }
                    
                    if (!document.getElementById('fieldOfStudy').value) {
                        alert('لطفاً رشته تحصیلی خود را انتخاب کنید.');
                        return false;
                    }
                    
                    if (!document.getElementById('residenceStatus').value) {
                        alert('لطفاً وضعیت سکونت خود را انتخاب کنید.');
                        return false;
                    }
                }
                
                const currentFormId = forms[currentFormIndex]?.id;
                if (!currentFormId || currentFormIndex === 0) return true;
                
                const form = document.getElementById(currentFormId);
                const questionGroups = form.querySelectorAll('.question-item');
                
                for (let group of questionGroups) {
                    const checked = group.querySelector('input[type="radio"]:checked');
                    if (!checked) {
                        const questionNumber = group.querySelector('.question-text').textContent.split('.')[0];
                        alert(`لطفاً به سوال ${questionNumber} پاسخ دهید.`);
                        group.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return false;
                    }
                }
                
                return true;
            }

            function updateFormIndicator() {
                const indicator = document.getElementById('formIndicator');
                if (currentFormIndex < forms.length) {
                    if (currentFormIndex === 0) {
                        indicator.textContent = `اطلاعات دموگرافیک`;
                    } else {
                        indicator.textContent = `فرم ${currentFormIndex} از ${forms.length - 1} (${forms[currentFormIndex].title})`;
                    }
                    indicator.className = 'badge bg-info p-2';
                } else {
                    indicator.textContent = 'آماده برای ارسال';
                    indicator.className = 'badge bg-success p-2';
                }
            }

            function updateProgressBar() {
                const totalItems = 4 + 28 + 26 + 24;
                let answered = 0;
                
                if (document.getElementById('age').value) answered++;
                if (document.getElementById('educationLevel').value) answered++;
                if (document.getElementById('semester').value) answered++;
                if (document.getElementById('fieldOfStudy').value) answered++;
                if (document.getElementById('residenceStatus').value) answered++;
                
                answered += document.querySelectorAll('#ghq-questions input[type="radio"]:checked').length;
                answered += document.querySelectorAll('#scs-questions input[type="radio"]:checked').length;
                answered += document.querySelectorAll('#esq-questions input[type="radio"]:checked').length;
                
                const progress = (answered / totalItems) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }

            function reviewAnswers() {
                currentFormIndex = 1;
                showCurrentForm();
            }

            // جمع‌آوری داده‌ها - فقط داده‌های ضروری
            function collectDataForDatabase() {
                const data = {
                    age: parseInt(document.getElementById('age').value),
                    student_code: document.getElementById('studentCode').value || null,
                    education_level: parseInt(document.getElementById('educationLevel').value),
                    semester: parseInt(document.getElementById('semester').value),
                    field_of_study: parseInt(document.getElementById('fieldOfStudy').value),
                    residence_status: parseInt(document.getElementById('residenceStatus').value),
                    submission_date: new Date().toISOString(),
                    
                    ghq_answers: {},
                    scs_answers: {},
                    esq_answers: {},
                    scores: {}
                };
                
                // جمع‌آوری پاسخ‌های GHQ
                for (let i = 1; i <= 28; i++) {
                    const value = getRadioValue(`ghq_${i}`);
                    if (value !== null) {
                        data.ghq_answers[`q${i}`] = value;
                    }
                }
                
                // جمع‌آوری پاسخ‌های SCS
                for (let i = 1; i <= 26; i++) {
                    const value = getRadioValue(`scs_${i}`);
                    if (value !== null) {
                        data.scs_answers[`q${i}`] = value;
                    }
                }
                
                // جمع‌آوری پاسخ‌های ESQ
                for (let i = 1; i <= 24; i++) {
                    const value = getRadioValue(`esq_${i}`);
                    if (value !== null) {
                        data.esq_answers[`q${i}`] = value;
                    }
                }
                
                // محاسبه نمرات نهایی (تحلیلگر خودش معکوس می‌کند)
                const scores = calculateScores();
                data.scores = {
                    ghq_total: scores.ghq_total,
                    scs_total: scores.scs_total,
                    esq_total: scores.esq_total,
                    ghq_average: parseFloat(scores.ghq_average),
                    scs_average: parseFloat(scores.scs_average),
                    esq_average: parseFloat(scores.esq_average)
                };
                
                return data;
            }

            // Helper function to get radio value
            function getRadioValue(name) {
                const radio = document.querySelector(`input[name="${name}"]:checked`);
                return radio ? parseInt(radio.value) : null;
            }

            // محاسبه نمرات (تحلیلگر خودش معکوس می‌کند، ما فقط جمع می‌کنیم)
            function calculateScores() {
                // Calculate GHQ score
                let ghqTotal = 0;
                for (let i = 1; i <= 28; i++) {
                    const value = getRadioValue(`ghq_${i}`);
                    if (value !== null) ghqTotal += value;
                }
                
                // Calculate SCS score - فقط جمع ساده
                let scsTotal = 0;
                for (let i = 1; i <= 26; i++) {
                    const value = getRadioValue(`scs_${i}`);
                    if (value !== null) {
                        scsTotal += value;
                    }
                }
                
                // Calculate ESQ score - فقط جمع ساده
                let esqTotal = 0;
                for (let i = 1; i <= 24; i++) {
                    const value = getRadioValue(`esq_${i}`);
                    if (value !== null) {
                        esqTotal += value;
                    }
                }
                
                return {
                    ghq_total: ghqTotal,
                    scs_total: scsTotal,
                    esq_total: esqTotal,
                    ghq_average: (ghqTotal / 28).toFixed(2),
                    scs_average: (scsTotal / 26).toFixed(2),
                    esq_average: (esqTotal / 24).toFixed(2)
                };
            }

            // ارسال داده‌ها به Supabase
            async function submitAllForms() {
                if (!validateAllForms()) {
                    alert('لطفاً به تمام سوالات ضروری پاسخ دهید.');
                    return;
                }
                
                const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
                loadingModal.show();
                
                try {
                    const responseData = collectDataForDatabase();
                    
                    if (!supabaseClient) {
                        throw new Error('Supabase client not initialized.');
                    }
                    
                    const { data, error } = await supabaseClient
                        .from('questionnaire_responses')
                        .insert([responseData]);
                    
                    if (error) throw error;
                    
                    loadingModal.hide();
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    
                    setTimeout(() => {
                        successModal.hide();
                        resetForm();
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error saving data:', error);
                    loadingModal.hide();
                    
                    // حالت fallback
                    const useLocalStorage = confirm(
                        'اتصال به سرور برقرار نیست. آیا می‌خواهید پاسخ‌ها را به صورت موقت در مرورگر ذخیره کنید؟'
                    );
                    
                    if (useLocalStorage) {
                        const responseData = collectDataForDatabase();
                        const backupKey = `questionnaire_backup_${Date.now()}`;
                        localStorage.setItem(backupKey, JSON.stringify(responseData));
                        alert(`پاسخ‌های شما با کد ${backupKey} در مرورگر ذخیره شد. لطفاً این کد را به محقق ارائه دهید.`);
                        resetForm();
                    } else {
                        alert('خطا در ذخیره اطلاعات. لطفاً دوباره تلاش کنید.');
                    }
                }
            }

            function validateAllForms() {
                const age = document.getElementById('age').value;
                if (!age || age < 15 || age > 50) {
                    alert('لطفاً سن خود را به درستی وارد کنید (بین 15 تا 50 سال).');
                    return false;
                }
                
                if (!document.getElementById('educationLevel').value) {
                    alert('لطفاً مقطع تحصیلی خود را انتخاب کنید.');
                    return false;
                }
                
                if (!document.getElementById('semester').value) {
                    alert('لطفاً ترم/سال تحصیلی خود را انتخاب کنید.');
                    return false;
                }
                
                if (!document.getElementById('fieldOfStudy').value) {
                    alert('لطفاً رشته تحصیلی خود را انتخاب کنید.');
                    return false;
                }
                
                if (!document.getElementById('residenceStatus').value) {
                    alert('لطفاً وضعیت سکونت خود را انتخاب کنید.');
                    return false;
                }
                
                // Validate all questions
                const questionGroups = document.querySelectorAll('.question-item');
                
                for (let group of questionGroups) {
                    const checked = group.querySelector('input[type="radio"]:checked');
                    if (!checked) {
                        const questionNumber = group.querySelector('.question-text').textContent.split('.')[0];
                        alert(`لطفاً به سوال ${questionNumber} پاسخ دهید.`);
                        group.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return false;
                    }
                }
                
                return true;
            }

            function resetForm() {
                document.getElementById('age').value = '';
                document.getElementById('studentCode').value = '';
                document.getElementById('educationLevel').value = '';
                document.getElementById('semester').value = '';
                document.getElementById('fieldOfStudy').value = '';
                document.getElementById('residenceStatus').value = '';
                
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });
                
                currentFormIndex = 0;
                showCurrentForm();
                updateProgressBar();
            }

            // توابع global
            window.showNextForm = showNextForm;
            window.showPreviousForm = showPreviousForm;
            window.reviewAnswers = reviewAnswers;
            window.submitAllForms = submitAllForms;
            window.updateProgressBar = updateProgressBar;
        })();
    </script>
</body>
</html>